(function(a){a.widget("lws.lac_model",{options:{mode:"autocomplete",resChange:undefined,resLoad:undefined,viewoptions:undefined,dom:undefined,initvalues:undefined},_create:function(){this._setSource();this.ajaxLoaded=false;this.ajaxString=undefined;a.ajaxSettings.cache=false;if(this.options.initvalues!=undefined){this.returnLabels(this.options.initvalues)}},_bind:function(b,c,d){return function(){return b.apply(c,d)}},_setSource:function(){var b=this.options.dom;this.dataSource={};this.ajax={};if(b[0].nodeName=="SELECT"){for(var c=0;c<b[0].options.length;c++){var d={};d.value=b[0].options[c].value;d.label=b[0].options[c].text;this.dataSource[b[0].options[c].value]=d}}if(this.options.viewoptions.source!=undefined){this.dataSource=this.options.viewoptions.source}if(b.data("source")!=undefined){this.dataSource=lwsBase64.toObj(b.data("source"))}if(this.options.viewoptions.ajax!=undefined){this.ajax.action=this.options.viewoptions.ajax}if(b.data("ajax")!=undefined){this.ajax.action=b.data("ajax")}if(this.options.viewoptions.spec!=undefined){this.ajax.spec=this.options.viewoptions.spec}if(b.data("spec")!=undefined){this.ajax.spec=b.data("spec")}if(this.options.viewoptions.sourceurl!=undefined){this.ajax.sourceurl=this.options.viewoptions.sourceurl}if(b.data("sourceurl")!=undefined){this.ajax.sourceurl=b.data("sourceurl")}if(this.options.viewoptions.minsearch!=undefined){this.options.minsearch=this.options.viewoptions.minsearch}if(b.data("minsearch")!=undefined){this.options.minsearch=b.data("minsearch")}if(this.options.viewoptions.minoption!=undefined){this.options.minoption=this.options.viewoptions.minoption}if(b.data("minoption")!=undefined){this.options.minoption=b.data("minoption")}if(this.options.viewoptions.minlength!=undefined){this.options.minlength=this.options.viewoptions.minlength}if(b.data("minlength")!=undefined){this.options.minlength=b.data("minlength")}},returnLabels:function(b,c){if(c!=undefined&&c!=""){this.options.resChange.target=c;this.options.resLoad.target=c}result=[];if(b!=undefined&&b!=false){for(var e=0;e<b.length;e++){var d=this.dataSource[b[e]];if(d==undefined||d==""){if(this.ajax.sourceurl!=undefined&&this.ajax.sourceurl!=""){this._remoteSource(b,"init",true);break}else{d={};d.value=b[e];d.label=b[e];d.html=""}}if(d){result.push(d)}}}this._sendBack(result,"init")},getValuesFromLabels:function(b,e){result=[];for(var d=0;d<b.length;d++){if(b[d]!=""){var c=this._mainSearch(b[d],this.dataSource,false)[0];if(c==undefined||c==""){if(e==undefined||!e){c={};c.value=b[d];c.label=b[d];c.html="";result.push(c)}}else{result.push(c)}}}return result},research:function(c,b){if(c==""||c==undefined){return}if(b!=undefined&&b!=""){this.options.resChange.target=b;this.options.resLoad.target=b}if(c.length<this.options.minlength){return}if(this.ajaxLoaded&&c.toLowerCase().substring(0,this.ajaxString.length)==this.ajaxString.toLowerCase){resultData=this._mainSearch(c,this.dataSource);this._sendBack(resultData,"ok")}else{this.ajaxLoaded=false;this.ajaxString=undefined;if(c.length>this.options.minsearch&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{resultData=this._mainSearch(c,this.dataSource);if(resultData.length<this.options.minoption&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(c)}else{this._sendBack(resultData,"ok")}}}},getSource:function(){var c=[];for(var b in this.dataSource){c.push(this.dataSource[b])}return c},addToSource:function(c){for(var b in c){if(this.dataSource[b]==""||this.dataSource[b]==undefined){res={};res.value=c[b];res.label=c[b];res.html="";this.dataSource[b]=res}}},_mainSearch:function(c,e,b){resultData=[];for(var d in e){researched=(b==true)?d.toLowerCase():e[d].label.toLowerCase();if(this.options.mode=="autocomplete"){if(researched.substring(0,c.length)==c.toLowerCase()){resultData.push(e[d])}}else{if(this.options.mode=="research"){if(researched.search(c.toLowerCase())!=-1){resultData.push(e[d])}}}}return resultData},_sendBack:function(c,b){result=[c,b];if(this.options.resChange!=undefined){this.options.resChange.fn.apply(this.options.resChange.target,[result])}},_remoteSource:function(e,b,d){if(this.options.resLoad!=undefined){this.options.resLoad.fn.apply(this.options.resLoad.target)}var c={action:this.ajax.action,term:e,fromValue:d};if(this.ajax.spec!=undefined){c.spec=this.ajax.spec}ajax_url=(this.ajax.sourceurl!=undefined)?this.ajax.sourceurl:lws_ajax_url;var f=this;a.getJSON(ajax_url,c,function(g){resultData=[];if(null==g){status="Autocomplete ressource error."}else{if(0===g){status="Autocomplete action not found."}else{for(var j in g){if(f.dataSource[j]==""||f.dataSource[j]==undefined){f.dataSource[j]=g[j]}}if(b!=undefined){for(var h=0;h<e.length;h++){resultData.push(g[e[h]])}f._sendBack(resultData,b)}else{status="ok";f.ajaxLoaded=true;f.ajaxString=e;resultData=f._mainSearch(e,f.dataSource);f._sendBack(resultData,status)}}}}).fail(function(h,i,g){resultData=[];status="Autocomplete loading error, status: "+i+", error: "+g;f._sendBack(resultData,status)})}})})(jQuery);